name: Sync Upstream and Create PR

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout deines Repos inkl. Historie
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      # 2. Upstream-Remote hinzufügen und fetchen
      - name: Fetch upstream
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git remote add upstream https://github.com/opencloud-eu/opencloud-compose.git
          git fetch upstream

      # 3. Neuen Branch für Upstream-Merge erstellen
      - name: Create sync branch
        run: |
          git checkout -B update-from-upstream main
          git merge --ff-only upstream/main || true

      # 4. Changelog generieren (Commits zwischen main und upstream)
      - name: Generate changelog
        id: changelog
        run: |
          git log --pretty=format:'- %h %s (%an)' main..update-from-upstream > changelog.md

      # 5. Branch pushen
      - name: Push branch
        run: git push origin update-from-upstream --force

      # 6. Pull-Request öffnen (nur wenn neue Commits)
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update-from-upstream       # Quell-Branch des PRs
          base: main                        # Ziel-Branch (muss verschieden sein!)
          assignees: reniko
          title: 'Sync mit upstream opencloud-compose'
          body: |
            Dieser Pull Request synchronisiert deinen Fork mit dem Upstream-Projekt.

            **Changelog (neue Commits):**
            ```markdown
            ${{ steps.changelog.outputs.stdout }}
            ```

          labels: upstream-update
          draft: false
