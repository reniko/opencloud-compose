services:
  collabora:
    environment:
      extra_params: >
        --o:ssl.enable=${COLLABORA_SSL_ENABLE:-true}
        --o:ssl.ssl_verification=${COLLABORA_SSL_VERIFICATION:-true}
        --o:ssl.termination=true
        --o:welcome.enable=false
        --o:net.frame_ancestors=${OC_DOMAIN:-cloud.opencloud.test}${TRAEFIK_PORT_HTTPS:+:}${TRAEFIK_PORT_HTTPS:-}
        --o:net.lok_allow.host[14]=${OC_DOMAIN:-cloud.opencloud.test}${TRAEFIK_PORT_HTTPS:+:}${TRAEFIK_PORT_HTTPS:-}
        --o:home_mode.enable=${COLLABORA_HOME_MODE:-false}
        --o:hexify_embedded_urls=true
    networks:
      pangolin:
      opencloud-net:

  opencloud:
    networks:
      pangolin:
      opencloud-net:
    ports:
      - 127.0.0.1:9200:9200 # local opencloud for webdav

  collaboration:
    networks:
      pangolin:
      opencloud-net:

  keycloak:
    networks:
      pangolin:
      opencloud-net:

  postgres:
    volumes:
      - ${KC_CUSTOM_DB_PATH:-keycloak_postgres_data}:/var/lib/postgresql/data

  opencloud-backup:
    image: alpine:latest
    container_name: opencloud-backup
    restart: unless-stopped
    networks:
      - opencloud-net
      - monitoring
    depends_on:
      - postgres
      - ldap-server
    volumes:
      - ${BACKUP_DIR:-/opt/data/opencloud_backups}:/opt/data/backups
    environment:
      DB_HOST: postgres
      DB_NAME: keycloak
      DB_USER: ${KC_DB_USERNAME:-keycloak}
      DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak}

      LDAP_HOST: ldap-server
      LDAP_PORT: "1636"
      LDAP_BIND_DN: "cn=admin,dc=opencloud,dc=eu"
      LDAP_BIND_PASSWORD: ${LDAP_BIND_PASSWORD:-admin}
      LDAP_BASE_DN: "dc=opencloud,dc=eu"

      UPTIME_KUMA_PUSH_URL: ${UPTIME_KUMA_PUSH_URL:-https://uptime.example.org/api/push/your-token}
      BACKUP_INTERVAL_SECONDS: ${BACKUP_INTERVAL_SECONDS:-3600}

    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -eu
        apk add --no-cache postgresql-client openldap-clients curl

        while true; do
          TS=$$(date +"%Y%m%d%H%M%S")
          BACKUP_FAILED=0

          mkdir -p /opt/data/backups/postgres /opt/data/backups/ldap

          # Postgres dump
          if ! PGPASSWORD="$$DB_PASSWORD" \
            pg_dump -h "$$DB_HOST" -U "$$DB_USER" "$$DB_NAME" \
            | gzip > "/opt/data/backups/postgres/keycloak-db-$$TS.sql.gz"
          then
            BACKUP_FAILED=1
          fi

          # LDAP export
          if ! ldapsearch -x -H "ldaps://$$LDAP_HOST:$$LDAP_PORT" \
            -D "$$LDAP_BIND_DN" -w "$$LDAP_BIND_PASSWORD" \
            -b "$$LDAP_BASE_DN" -LLL "(objectClass=*)" \
            > "/opt/data/backups/ldap/ldap-$$TS.ldif"
          then
            BACKUP_FAILED=1
          fi

          # retention 7 Tage
          find /opt/data/backups/postgres -type f -mtime +7 -delete || true
          find /opt/data/backups/ldap     -type f -mtime +7 -delete || true

          # Uptime Kuma push
          if [ -n "$$UPTIME_KUMA_PUSH_URL" ]; then
            if [ "$$BACKUP_FAILED" -eq 0 ]; then
              curl -fsS --retry 3 "$$UPTIME_KUMA_PUSH_URL" || true
            else
              curl -fsS --retry 3 "$$UPTIME_KUMA_PUSH_URL?status=down" || true
            fi
          fi

          sleep "$$BACKUP_INTERVAL_SECONDS"
        done

networks:
  pangolin:
    name: pangolin
    external: true
  monitoring:
    name: monitoring
    external: true